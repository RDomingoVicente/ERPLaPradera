{% extends "Master/MenuTemplate.html.twig" %}

{% block body %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h3>
                        <i class="fas fa-file-invoice fa-fw"></i> {{ i18n.trans('parse-invoice-pdf') }}
                    </h3>
                </div>
                <div class="card-body">
                    {# Formulario de subida #}
                    <form action="{{ fsc.url() }}" method="post" enctype="multipart/form-data" class="form">
                        <input type="hidden" name="action" value="upload"/>
                        
                        {# Selector de Proveedor #}
                        <div class="form-group">
                            <label for="provider">
                                <i class="fas fa-building"></i> {{ i18n.trans('supplier') }}
                            </label>
                            <select class="form-control" id="provider" name="provider" required>
                                <option value="">{{ i18n.trans('Seleccione proveedor') }}</option>
                                <option value="TUDIS">Tudis</option>
                                <option value="LACALLE">Embutidos la calle</option>
                                <option value="GM">Transgourmet GM</option>
                                <option value="BEBIDASMARTIN">Bebidas Martin</option>
                                <option value="otro">{{ i18n.trans('other') }}</option>
                            </select>
                            <small class="form-text text-muted">
                                {{ i18n.trans('select-supplier-to-use-correct-template') }}
                            </small>
                        </div>
                        
                        {# Selector de archivo PDF #}
                        <div class="form-group">
                            <label for="pdf_file">
                                <i class="fas fa-file-pdf"></i> {{ i18n.trans('select-pdf-file') }}
                            </label>
                            <div class="custom-file">
                                <input type="file" 
                                       class="custom-file-input" 
                                       id="pdf_file" 
                                       name="pdf_file" 
                                       accept="application/pdf"
                                       required>
                                <label class="custom-file-label" for="pdf_file">
                                    {{ i18n.trans('choose-file') }}
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                {{ i18n.trans('max-file-size-10mb') }}
                            </small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload"></i> {{ i18n.trans('upload-and-parse') }}
                        </button>
                    </form>
                </div>
            </div>

            {# Mostrar resultados del parseo #}
            {% if fsc.invoiceData %}
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4>
                        <i class="fas fa-check-circle"></i> {{ i18n.trans('parse-results') }}
                    </h4>
                </div>
                <div class="card-body">
                    {# Mostrar proveedor seleccionado #}
                    {% if fsc.selectedProvider %}
                    <div class="alert alert-info">
                        <strong><i class="fas fa-building"></i> {{ i18n.trans('supplier') }}:</strong> 
                        {{ fsc.selectedProvider|upper }}
                    </div>
                    {% endif %}

                    <div class="row">
                        {# Información del proveedor #}
                        {% if fsc.invoiceData.issuer %}
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5><i class="fas fa-building"></i> {{ i18n.trans('supplier-info') }}</h5>
                                </div>
                                <div class="card-body">
                                    {% if fsc.invoiceData.issuer.name %}
                                    <p><strong>{{ i18n.trans('name') }}:</strong> {{ fsc.invoiceData.issuer.name }}</p>
                                    {% endif %}
                                    {% if fsc.invoiceData.issuer.vat_number %}
                                    <p><strong>{{ i18n.trans('vat-number') }}:</strong> {{ fsc.invoiceData.issuer.vat_number }}</p>
                                    {% endif %}
                                    {% if fsc.invoiceData.issuer.address %}
                                    <p><strong>{{ i18n.trans('address') }}:</strong> {{ fsc.invoiceData.issuer.address }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {# Información de la factura #}
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5><i class="fas fa-file-invoice-dollar"></i> {{ i18n.trans('invoice-info') }}</h5>
                                </div>
                                <div class="card-body">
                                    {% if fsc.invoiceData.invoice_number %}
                                    <p><strong>{{ i18n.trans('invoice-number') }}:</strong> {{ fsc.invoiceData.invoice_number }}</p>
                                    {% endif %}
                                    {% if fsc.invoiceData.date %}
                                    <p><strong>{{ i18n.trans('date') }}:</strong> {{ fsc.invoiceData.date }}</p>
                                    {% endif %}
                                    {% if fsc.invoiceData.due_date %}
                                    <p><strong>{{ i18n.trans('due-date') }}:</strong> {{ fsc.invoiceData.due_date }}</p>
                                    {% endif %}
                                    {% if fsc.invoiceData.amount %}
                                    <p><strong>{{ i18n.trans('total-amount') }}:</strong> 
                                        <span class="badge badge-success badge-lg">
                                            {{ fsc.invoiceData.amount }} {{ fsc.invoiceData.currency|default('EUR') }}
                                        </span>
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Líneas de la factura #}
                    {% if fsc.invoiceData.lines %}
                    <div class="card mt-3">
                        <div class="card-header bg-secondary text-white">
                            <h5><i class="fas fa-list"></i> {{ i18n.trans('invoice-lines') }}</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>{{ i18n.trans('description') }}</th>
                                            <th class="text-right">{{ i18n.trans('quantity') }}</th>
                                            <th class="text-right">{{ i18n.trans('unit-price') }}</th>
                                            <th class="text-right">{{ i18n.trans('total') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for line in fsc.invoiceData.lines %}
                                        <tr>
                                            <td>{{ line.description|default('-') }}</td>
                                            <td class="text-right">{{ line.quantity|default('-') }}</td>
                                            <td class="text-right">{{ line.unit_price|default('-') }}</td>
                                            <td class="text-right">
                                                <strong>{{ line.total|default('-') }}</strong>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {# Datos adicionales en formato JSON #}
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5>
                                <i class="fas fa-code"></i> {{ i18n.trans('raw-data') }}
                                <button class="btn btn-sm btn-outline-secondary float-right" 
                                        onclick="document.getElementById('rawData').classList.toggle('d-none')">
                                    <i class="fas fa-eye"></i> {{ i18n.trans('show-hide') }}
                                </button>
                            </h5>
                        </div>
                        <div class="card-body d-none" id="rawData">
                            <pre class="bg-light p-3" style="max-height: 400px; overflow-y: auto;">{{ fsc.invoiceData|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>
                        </div>
                    </div>

                    {# Botones de acción #}
                    <div class="mt-3">
                        <a href="{{ fsc.url() }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> {{ i18n.trans('parse-another') }}
                        </a>
                        {# Aquí puedes añadir más botones como "Crear Factura", "Exportar", etc. #}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{# Script para mostrar nombre del archivo seleccionado #}
<script>
document.getElementById('pdf_file').addEventListener('change', function(e) {
    var fileName = e.target.files[0].name;
    var label = e.target.nextElementSibling;
    label.textContent = fileName;
});
</script>
{% endblock %}