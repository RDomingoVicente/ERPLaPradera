{# View/Invoice2DataParser.html.twig #}
{% extends "Master/MenuTemplate.html.twig" %}

{% block body %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h3>
                        <i class="fas fa-file-invoice fa-fw"></i> {{ i18n.trans('parse-invoice-pdf') }}
                    </h3>
                </div>
                <div class="card-body">
                    {# Formulario de subida #}
                    <form action="{{ fsc.url() }}" method="post" enctype="multipart/form-data" class="mb-4">
                        <input type="hidden" name="action" value="upload"/>
                        {{ formToken() }}
                        
                        <div class="form-group">
                            <label for="pdf_file">
                                <i class="fas fa-file-pdf"></i> {{ i18n.trans('select-pdf-file') }}
                            </label>
                            <div class="custom-file">
                                <input type="file" 
                                       class="custom-file-input" 
                                       id="pdf_file" 
                                       name="pdf_file" 
                                       accept="application/pdf"
                                       required>
                                <label class="custom-file-label" for="pdf_file">
                                    {{ i18n.trans('choose-file') }}
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                {{ i18n.trans('max-file-size-10mb') }}
                            </small>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload"></i> {{ i18n.trans('parse-invoice') }}
                        </button>
                    </form>

                    {# Mostrar resultado si existe #}
                    {% set invoiceData = fsc.invoiceData %}
                    {% if invoiceData %}
                    <hr>
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle"></i> {{ i18n.trans('invoice-parsed') }}</h5>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <strong>{{ i18n.trans('supplier-data') }}</strong>
                                </div>
                                <div class="card-body">
                                    {% if invoiceData.issuer %}
                                        <p><strong>{{ i18n.trans('name') }}:</strong> {{ invoiceData.issuer }}</p>
                                    {% endif %}
                                    {% if invoiceData.vat %}
                                        <p><strong>{{ i18n.trans('vat') }}:</strong> {{ invoiceData.vat }}</p>
                                    {% endif %}
                                    {% if invoiceData.address %}
                                        <p><strong>{{ i18n.trans('address') }}:</strong> {{ invoiceData.address }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <strong>{{ i18n.trans('invoice-data') }}</strong>
                                </div>
                                <div class="card-body">
                                    {% if invoiceData.invoice_number %}
                                        <p><strong>{{ i18n.trans('invoice-number') }}:</strong> {{ invoiceData.invoice_number }}</p>
                                    {% endif %}
                                    {% if invoiceData.date %}
                                        <p><strong>{{ i18n.trans('date') }}:</strong> {{ invoiceData.date }}</p>
                                    {% endif %}
                                    {% if invoiceData.due_date %}
                                        <p><strong>{{ i18n.trans('due-date') }}:</strong> {{ invoiceData.due_date }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-warning">
                                    <strong>{{ i18n.trans('amounts') }}</strong>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            {% if invoiceData.amount %}
                                                <p><strong>{{ i18n.trans('subtotal') }}:</strong> {{ invoiceData.amount }}</p>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-4">
                                            {% if invoiceData.amount_tax %}
                                                <p><strong>{{ i18n.trans('tax') }}:</strong> {{ invoiceData.amount_tax }}</p>
                                            {% endif %}
                                        </div>
                                        <div class="col-md-4">
                                            {% if invoiceData.amount_total %}
                                                <p class="h5"><strong>{{ i18n.trans('total') }}:</strong> {{ invoiceData.amount_total }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Líneas de factura si existen #}
                    {% if invoiceData.lines %}
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    <strong>{{ i18n.trans('invoice-lines') }}</strong>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>{{ i18n.trans('description') }}</th>
                                                    <th class="text-right">{{ i18n.trans('quantity') }}</th>
                                                    <th class="text-right">{{ i18n.trans('price') }}</th>
                                                    <th class="text-right">{{ i18n.trans('total') }}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for line in invoiceData.lines %}
                                                <tr>
                                                    <td>{{ line.description ?? '-' }}</td>
                                                    <td class="text-right">{{ line.quantity ?? '-' }}</td>
                                                    <td class="text-right">{{ line.price ?? '-' }}</td>
                                                    <td class="text-right">{{ line.total ?? '-' }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {# Botón para crear factura (opcional) #}
                    <div class="mt-3">
                        <a href="#" class="btn btn-success" onclick="alert('Aquí puedes implementar la creación automática de la factura');">
                            <i class="fas fa-plus-circle"></i> {{ i18n.trans('create-supplier-invoice') }}
                        </a>
                    </div>

                    {# JSON raw para debug #}
                    <div class="mt-3">
                        <button class="btn btn-sm btn-secondary" type="button" data-toggle="collapse" data-target="#jsonData">
                            <i class="fas fa-code"></i> {{ i18n.trans('show-raw-data') }}
                        </button>
                        <div class="collapse mt-2" id="jsonData">
                            <pre class="bg-light p-3"><code>{{ invoiceData|json_encode(constant('JSON_PRETTY_PRINT')) }}</code></pre>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{# Script para actualizar el nombre del archivo en el input #}
<script>
    document.getElementById('pdf_file').addEventListener('change', function(e) {
        var fileName = e.target.files[0]?.name || 'Elegir archivo';
        var label = e.target.nextElementSibling;
        label.textContent = fileName;
    });
</script>
{% endblock %}
